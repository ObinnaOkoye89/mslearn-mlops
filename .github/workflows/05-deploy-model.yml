name: Deploy AML Model

on:
  workflow_dispatch:  # Allows manual trigger for deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create or update online endpoint
      run: |
        # Create endpoint (if not exists)
        az ml online-endpoint create --name diabetes-endpoint --resource-group MLOps --workspace-name diabetes-ml-ws || true

    - name: Deploy latest model
      run: |
        MODEL_VERSION=$(az ml model list \
          --name diabetes-classifier \
          --resource-group MLOps \
          --workspace-name diabetes-ml-ws \
          --query "max_by([], &version).version" \
          -o tsv)
    
        echo "Latest model version: $MODEL_VERSION"
    
        if [ -z "$MODEL_VERSION" ]; then
          echo "ERROR: No model versions found for 'diabetes-classifier'"
          exit 1
        fi
    
        # Replace version in YAML
        sed -i "s/PLACEHOLDER/$MODEL_VERSION/" deployment.yml
    
        # Deploy using YAML
        az ml online-deployment create \
          --file deployment.yml \
          --resource-group MLOps \
          --workspace-name diabetes-ml-ws \
          --all-traffic
             
