name: Deploy AML Model

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Ensure online endpoint exists
      run: |
        ENDPOINT_NAME="diabetes-endpoint"
        RESOURCE_GROUP="MLOps"
        WORKSPACE="diabetes-ml-ws"

        # Try updating the endpoint; fail silently if it doesn't exist
        az ml online-endpoint update \
          --name $ENDPOINT_NAME \
          --resource-group $RESOURCE_GROUP \
          --workspace-name $WORKSPACE || echo "Endpoint not found, please create manually."

        echo "Ensure that the endpoint exists in Azure ML Studio before running this workflow."

    - name: Deploy latest model
      run: |
        ENDPOINT_NAME="diabetes-endpoint"
        DEPLOYMENT_NAME="diabetes-deployment"
        RESOURCE_GROUP="MLOps"
        WORKSPACE="diabetes-ml-ws"

        # Get latest model version
        MODEL_VERSION=$(az ml model list \
          --name diabetes-classifier \
          --resource-group $RESOURCE_GROUP \
          --workspace-name $WORKSPACE \
          --query "max_by([], &version).version" \
          -o tsv)

        echo "Latest model version: $MODEL_VERSION"

        if [ -z "$MODEL_VERSION" ]; then
          echo "ERROR: No model versions found for 'diabetes-classifier'"
          exit 1
        fi

        # Replace version in deployment YAML
        sed -i "s/PLACEHOLDER/$MODEL_VERSION/" _deployment.yml

        # Deploy using YAML
        az ml online-deployment create \
          --file _deployment.yml \
          --resource-group $RESOURCE_GROUP \
          --workspace-name $WORKSPACE \
          --all-traffic

    - name: Test deployed endpoint
      run: |
        ENDPOINT_NAME="diabetes-endpoint"
        RESOURCE_GROUP="MLOps"
        WORKSPACE="diabetes-ml-ws"

        echo "Testing endpoint..."
        az ml online-endpoint invoke \
          --name $ENDPOINT_NAME \
          --resource-group $RESOURCE_GROUP \
          --workspace-name $WORKSPACE \
          --request-file test_input.json
